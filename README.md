# Bupgram

> Bup(Burning Passion)ì„ ê³µìœ í•˜ê³  ì†Œí†µí•  ìˆ˜ ìˆëŠ” SNS ì„œë¹„ìŠ¤

<p align="center">
  <img src="https://github.com/Seungwoo-Seo/LSLPTodogram/assets/72753868/1b62cbf6-3c4c-4d74-8629-76912faa8edf" width="130">
  <img src="https://github.com/Seungwoo-Seo/LSLPTodogram/assets/72753868/32f9cbbd-a750-4bf3-a400-b85e00ba3eed" width="130">
  <img src="https://github.com/Seungwoo-Seo/LSLPTodogram/assets/72753868/eda01cb4-8001-4854-b9b1-8c20b7ad9c0a" width="130">
  <img src="https://github.com/Seungwoo-Seo/LSLPTodogram/assets/72753868/6b3a4956-c8a2-4547-83e4-02b8c77d90a1" width="130">
  <img src="https://github.com/Seungwoo-Seo/LSLPTodogram/assets/72753868/10127fd9-6d4e-405a-a22d-458be6659808" width="130">
  <img src="https://github.com/Seungwoo-Seo/LSLPTodogram/assets/72753868/f24d0a7c-7ef5-4350-90e0-7a394cb70dce" width="130">
</p>

|ë©”ì¸ í™”ë©´|ë³¸ì¸ ê³„ì •|ê²Œì‹œê¸€(Bup ì‘ì„±)|ëŒ“ê¸€ ì‘ì„±|íƒ€ì¸ ê³„ì •|íšŒì›ì¸ì¦|
|:---:|:---:|:---:|:---:|:---:|:---:|
|<img src="https://github.com/Seungwoo-Seo/LSLPTodogram/assets/72753868/b17127b8-6c28-495c-8bab-477e2b81c0b0" width="150">|<img src="https://github.com/Seungwoo-Seo/LSLPTodogram/assets/72753868/fb58ef70-d0b5-45d1-a573-382c73dfc8e1" width="150">|<img src="https://github.com/Seungwoo-Seo/LSLPTodogram/assets/72753868/e85dcccb-5258-4f9a-b51a-bee5f090647c" width="150">|<img src="https://github.com/Seungwoo-Seo/LSLPTodogram/assets/72753868/89689a2f-ba5f-4705-9cf1-a6802485f736" width="150">|<img src="https://github.com/Seungwoo-Seo/LSLPTodogram/assets/72753868/cae74492-0b01-49d3-a798-91ac7e73c7d3" width="150">|<img src="https://github.com/Seungwoo-Seo/LSLPTodogram/assets/72753868/90168835-5fa0-447e-bb93-23a9df9a3c12" width="150">|

## ğŸ“± ì„œë¹„ìŠ¤

- ìµœì†Œ ë²„ì „ : iOS 15.0
- ê°œë°œ ì¸ì› : 1ì¸
- ê°œë°œ ê¸°ê°„ : 2023ë…„ 11ì›” 20ì¼ ~ 2024ë…„ 1ì›” 5ì¼ (7ì£¼)

## ğŸš€ ì„œë¹„ìŠ¤ ê¸°ëŠ¥

- ì´ë©”ì¼ íšŒì›ì¸ì¦ ê¸°ëŠ¥ ì œê³µ
- ê²Œì‹œê¸€(Bup) ì‘ì„±/ì¡°íšŒ/ì‚­ì œ/í•´ì‹œíƒœê·¸ ê¸°ëŠ¥ ì œê³µ
- ê²Œì‹œê¸€ ì¢‹ì•„ìš”/ëŒ“ê¸€ ê¸°ëŠ¥ ì œê³µ
- ê³„ì • íŒ”ë¡œìš°/ì–¸íŒ”ë¡œìš° ê¸°ëŠ¥ ì œê³µ

## ğŸ›  ì‚¬ìš© ê¸°ìˆ 

- Swift
- UIKit, PhotosUI
- MVVM, Input/Output Pattern, Router Pattern, Singleton
- RxSwift, RxDataSource, Alamofire, SnapKit, Kingfisher, Tabman, IQKeyboardManager, PanModal
- CodeBase UI, AutoLayout, Base, ViewIdentifiable, CompositionalLayout, DiffableDataSource, Codable, Keychain

## ğŸ’» í•µì‹¬ ì„¤ëª…

- RxSwift + MVVM êµ¬ì¡° ê¸°ë°˜ `Input/Output Pattern` ì ìš©
- AlamofireÂ ê¸°ë°˜Â `Router Pattern` ì ìš©,Â `Generic request`Â ë©”ì„œë“œ êµ¬í˜„
- multipart/form-data ê¸°ë°˜ `ì´ë¯¸ì§€ ì—…ë¡œë“œ` ë° `ë‹¤ìš´ ìƒ˜í”Œë§` êµ¬í˜„
- AuthenticationInterceptor ì‚¬ìš©í•´ JWT ê¸°ë°˜ `AccessToken ê°±ì‹ /RefreshToken ë§Œë£Œ` ë¡œì§ êµ¬í˜„
- Keychainì„ í†µí•œ Authí† í° `ì•”í˜¸í™” ì €ì¥` ë° ì—…ë°ì´íŠ¸ êµ¬í˜„
- cursor ê¸°ë°˜ `í˜ì´ì§€ ë„¤ì´ì…˜`ì„ í†µí•œ ê²Œì‹œê¸€ ë¡œë“œ
- ì´ë¯¸ì§€ ê°œìˆ˜ì— ë”°ë¥¸ `CollectionViewLayout ë³€ê²½` ë° `Image Cell Sizing` êµ¬í˜„
- Rx throttle operater + Dictionaryë¥¼ í†µí•œ ì¢‹ì•„ìš”/íŒ”ë¡œìš° `Optimistic UI` êµ¬í˜„

## ğŸš§ ê¸°ìˆ ì  ë„ì „

<!-- í”„ë¡œì íŠ¸ë¥¼ ì§„í–‰í•˜ë©´ì„œ ê²ªì€ ê¸°ìˆ ì ì¸ ë„ì „ê³¼ ì–´ë–»ê²Œ í•´ê²°í–ˆëŠ”ì§€ì— ëŒ€í•œ ì„¤ëª…ì„ ì¶”ê°€í•œë‹¤. -->
### 1. `AuthenticationInterceptor`ë¥¼ í™œìš©í•´ `JWT` ê¸°ë°˜ì˜ `AccessToken` ê°±ì‹ ê³¼ `RefreshToken` ë§Œë£Œ ë¡œì§ ê°œì„ í•˜ê¸°
- **ë„ì „ ìƒí™©**</br>
AccessToken ë§Œë£Œ ì‹œ(419) `RefreshToken`ìœ¼ë¡œ ì¬ìš”ì²­ ë¡œì§ê³¼ ë¦¬í”„ë ˆì‹œ í† í° ë§ˆì € ë§Œë£Œ ì‹œ `ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ì „í™˜` ë¡œì§ì´ í•„ìš”í–ˆìŠµë‹ˆë‹¤. ë§¤ ìš”ì²­ë§ˆë‹¤ ì¤‘ë³µëœ ì½”ë“œë¥¼ ê°œì„ í•˜ê³  ì‹¶ì—ˆê³  Alamofire 5.2ì— ë“±ì¥í•œ `AuthenticationInterceptor`ë¥¼ ì ìš©í•´ ë³´ì•˜ìŠµë‹ˆë‹¤.

- **ë„ì „ ê²°ê³¼**</br>
interceptorë¥¼ ì™¸ë¶€ì—ì„œ ë§Œë“¤ì–´ì„œ request ë©”ì„œë“œ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬í•´ì£¼ëŠ” ê²ƒë§Œìœ¼ë¡œ ëª¨ë“  ì²˜ë¦¬ê°€ ê°€ëŠ¥ì¼€ ë˜ì—ˆìŠµë‹ˆë‹¤.
~~~swift
import Foundation
import Alamofire

struct SesacAuthenticationCredential: AuthenticationCredential {
    let accessToken: String
    let refreshToken: String

    var requiresRefresh: Bool = false
}
~~~
~~~swift
import Foundation
import Alamofire
import RxSwift

final class SesacAuthenticator: Authenticator {
    typealias Credential = SesacAuthenticationCredential

    private let disposeBag = DisposeBag()

    func apply(
        _ credential: SesacAuthenticationCredential,
        to urlRequest: inout URLRequest
    ) {
        urlRequest.headers.add(.authorization(credential.accessToken))
    }

    func refresh(
        _ credential: SesacAuthenticationCredential,
        for session: Alamofire.Session,
        completion: @escaping (Result<SesacAuthenticationCredential, Error>) -> Void
    ) {
        NetworkManager.shared.request(
            type: RefreshResponse.self,
            api: AccountRouter.refresh(refreshToken: credential.refreshToken)
        )
        .subscribe { response in
            let credential = SesacAuthenticationCredential(
                accessToken: response.token,
                refreshToken: credential.refreshToken
            )
            completion(.success(credential))

        } onFailure: { error in
            completion(.failure(error))
        }
        .disposed(by: disposeBag)
    }

    func didRequest(
        _ urlRequest: URLRequest,
        with response: HTTPURLResponse,
        failDueToAuthenticationError error: Error
    ) -> Bool {
        return response.statusCode == 419
    }

    func isRequest(
        _ urlRequest: URLRequest,
        authenticatedWith credential: SesacAuthenticationCredential
    ) -> Bool {
        let accessToken = HTTPHeader.authorization(credential.accessToken).value
        return urlRequest.headers["Authorization"] == accessToken
    }
}
~~~
~~~swift
final class NetworkManager {
    ...

    func request<T: Decodable, E: NetworkAPIError>(
        type: T.Type,
        api: URLRequestConvertible,
        error: E.Type,
        interceptor: AuthenticationInterceptor<SesacAuthenticator>
    ) -> Single<T> {
        return Single<T>.create { observer in
            AF
                .request(api, interceptor: interceptor)
                .validate(statusCode: 200...299)
                .responseDecodable(of: type) { [weak self] (response) in
                    guard let self else {return}
                    switch response.result {
                    case .success(let success):
                        observer(.success(success))

                    case .failure(let afError):
                        self.handleNetworkError(error: afError, observer: observer, errorType: error)
                    }
                }

            return Disposables.create()
        }
    }

    ...
}
~~~

### 2. Optimistic UI ë„ì „
- **ë„ì „ ìƒí™©**</br>
ì¢‹ì•„ìš”ì™€ íŒ”ë¡œìš°/ì–¸íŒ”ë¡œìš°ì˜ ê²½ìš° ì‚¬ìš©ìê°€ í•´ë‹¹ ë²„íŠ¼ë“¤ì„ ëˆ„ë¥¼ ë•Œë§ˆë‹¤ ì„œë²„ì™€ í†µì‹ ì„ í•œë‹¤ëŠ”ê²Œ ë¦¬ì†ŒìŠ¤ ë‚­ë¹„ì§€ ì•Šì„ê¹Œ? ë¼ê³  ìƒê°í–ˆìŠµë‹ˆë‹¤. ë˜, ë§Œì•½ ì•…ì„± ì‚¬ìš©ìê°€ ìˆ˜ì²œ, ìˆ˜ë§Œë²ˆ ì¢‹ì•„ìš”/íŒ”ë¡œìš°/ì–¸íŒ”ë¡œìš°ë¥¼ í•œë‹¤ë©´ ìƒê°ì§€ë„ ëª»í•œ íŠ¸ë˜í”½ì´ ë°œìƒí•˜ê³  ê·¸ê²ƒì€ ê³§ `ë¹„ìš© ì´ìŠˆ`ê°€ ë°œìƒí•  ìˆ˜ ìˆê² ë‹¤ë¼ëŠ” ê²°ë¡ ì„ ì–»ì—ˆì—ˆìŠµë‹ˆë‹¤. ê·¸ë˜ì„œ í‚¤ì›Œë“œë¥¼ ì°¾ë˜ ì¤‘ `Optimistic UI`ë¥¼ ì•Œê²Œ ë˜ì—ˆê³  ì ìš©í•´ ë³´ì•˜ìŠµë‹ˆë‹¤.

- **ë„ì „ ê²°ê³¼**</br>
ì¢‹ì•„ìš” ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ë©´ ì„œë²„ì˜ `ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ì§€ ì•Šê³ ` `ì¦‰ê° UIë¥¼ ì—…ë°ì´íŠ¸` í•˜ê³ , ë¬´ë¶„ë³„í•œ API requestë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ `throttle operator` ì‚¬ìš©í•´ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤.
~~~swift
// ViewController

// ì¢‹ì•„ìš” ë²„íŠ¼ ëˆ„ë¥´ë©´
let didTapLikeButton = cell.communicationButtonStackView.likeButton.rx.tap
    .scan(item.isIliked) { lastState, _ in !lastState } // isSelected ìƒíƒœ í† ê¸€
    .flatMapLatest { isSelected in
        Observable<Void>.create { observer in
            // UI ì—…ë°ì´íŠ¸
            cell.communicationButtonStackView.likeButton.isSelected = isSelected
            let countString = item.localLikesCountString(isSelected: isSelected)
            cell.countButtonStackView.likeCountButton.updateTitle(title: countString)
            observer.onNext(Void())
            observer.onCompleted()
            return Disposables.create()
        }
    }
    .share()

let rowAndIsSelected = Observable.combineLatest(
    Observable.just(row),
    cell.communicationButtonStackView.likeButton.rx.observe(\.isSelected)
)

// ì´ë²¤íŠ¸ê°€ ë°œìƒí•œ ì¢‹ì•„ìš” ë²„íŠ¼ì˜ ì •ë³´ë¥¼ viewModelë¡œ ì „ë‹¬
didTapLikeButton
    .withLatestFrom(rowAndIsSelected)
    .bind(with: self) { owner, rowAndIsSelected in
        likeState.accept(rowAndIsSelected)
    }
    .disposed(by: cell.disposeBag)

// ë¬´ë¶„ë³„í•œ API requestë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ throttle operator ì‚¬ìš©
didTapLikeButton
    .throttle(.seconds(1), latest: false, scheduler: MainScheduler.instance)
    .withLatestFrom(Observable.just(item.id))
    .bind(to: didTapLikeButtonOfId)
    .disposed(by: cell.disposeBag)
~~~
~~~swift
// ViewModel

input.didTapLikeButtonOfId
    .flatMapLatest { (id) in
        return NetworkManager.shared.request(
            type: LikeUpdateResponseDTO.self,
            api: LikeRouter.update(id: id),
            error: NetworkError.LikeUpdateError.self
        )
        .trackActivity(activityIndicator)
        .trackError(errorTracker)
        .catch { _ in Observable.empty() }
        .map { $0.toDomain() }
    }
    .withLatestFrom(input.likeState) { (domain: $0, likeState: $1) }
    .bind(with: self) { owner, value in
        // MARK: êµ³ì´ response ê°’ì„ ì‚¬ìš©í•  í•„ìš”ê°€ ì—†ì–´ì¡Œë‹¤.
    }
    .disposed(by: disposeBag)

input.likeState
    .bind(with: self) { owner, localLikeState in
        owner.likeState.updateValue(localLikeState.isSelected, forKey: localLikeState.row)
    }
    .disposed(by: disposeBag)
~~~


## ğŸš¨ íŠ¸ëŸ¬ë¸” ìŠˆíŒ…

### 1. Singleë¡œ ë©í•‘í•œ REST API requestë¥¼ catch operatorë¡œ ì—ëŸ¬ í•¸ë“¤ë§ ì‹œ ìŠ¤íŠ¸ë¦¼ ì¢…ë£Œ ì´ìŠˆ
- **ë¬¸ì œ ì›ì¸**</br>
flatMapLatest ì™¸ë¶€ì—ì„œ catch operator ì‚¬ìš©í•˜ì—¬ completed ì´ë²¤íŠ¸ ë°©ì¶œ í›„ ìŠ¤íŠ¸ë¦¼ ì¢…ë£Œ

- **í•´ê²° ë°©ë²•**</br>
flatMapLatest ë‚´ë¶€ì—ì„œ catch operatorë¡œ ì—ëŸ¬ í•¸ë“¤ë§ ë° ìŠ¤íŠ¸ë¦¼ ìœ ì§€
~~~swift
.flatMapLatest { [unowned self] _ in
    return NetworkManager.shared.request(
        type: PostReadResponseDTO.self,
        api: PostRouter.read(parameters: self.baseParameters),
        error: NetworkError.PostReadError.self
    )
    .catch { _ in Single.never() }
}
~~~

### 2. AuthenticationInterceptor ê¸°ë°˜ interceptorÂ êµ¬í˜„ í›„ ì„œë²„ë¡œë¶€í„° 419(ì•¡ì„¸ìŠ¤ í† í° ë§Œë£Œ)ë¥¼ ì‘ë‹µë°›ì•˜ì„ ë•ŒÂ ë¬´í•œ ì¬ê·€Â ì´ìŠˆ
- **ë¬¸ì œ ì›ì¸**</br>
419ë¥¼ ì¡ì•˜ì„ ë•Œ interceptor retryì—ì„œ ê°±ì‹  requestë¥¼ ë³´ë‚¼ ë•Œë„ interceptorë¥¼ ì‚¬ìš©í–ˆë˜ ìƒí™©ì´ ì›ì¸
  
- **í•´ê²° ë°©ë²•**</br>
ì´ë¯¸ 419ë¥¼ ì¡ì•˜ê¸° ë•Œë¬¸ì— ë¦¬í”„ë˜ì‹œ í† í°ìœ¼ë¡œ ê°±ì‹  ìš”ì²­ì„ ë³´ë‚¼ ë• interceptorë¥¼Â `ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”`Â request ë©”ì„œë“œë¥¼ ì‚¬ìš©í•´ì„œ í•´ê²°
~~~swift
final class SesacAuthenticator: Authenticator {
    ...

    func refresh(
        _ credential: SesacAuthenticationCredential,
        for session: Alamofire.Session,
        completion: @escaping (Result<SesacAuthenticationCredential, Error>) -> Void
    ) {
        NetworkManager.shared.request(
            type: RefreshResponse.self,
            api: AccountRouter.refresh(refreshToken: credential.refreshToken)
        )
        .subscribe { response in
            let credential = SesacAuthenticationCredential(
                accessToken: response.token,
                refreshToken: credential.refreshToken
            )
            completion(.success(credential))

        } onFailure: { error in
            completion(.failure(error))
        }
        .disposed(by: disposeBag)
    }

    ...
}
~~~

<!--
## ğŸ“ íšŒê³ 
- `RxSwift`ë¥¼ ì ìš©í•˜ì—¬ `ë°˜ì‘í˜• í”„ë¡œê·¸ë˜ë°`ì— ëŒ€í•œ í”Œë¡œìš°ë¥¼ ê²½í—˜
- `JWT`ë¥¼ í™œìš©í•œ `ì‚¬ìš©ì ì¸ì¦` í”Œë¡œìš°ë¥¼ ê²½í—˜
- `Optimistic UI`ë¥¼ í†µí•´ íŠ¸ë˜í”½ ê°ì†Œ ë° ë¹„ìš© ì ˆê° íš¨ê³¼ë¥¼ ê²½í—˜
- `Router íŒ¨í„´`ì„ í†µí•´ ë„¤íŠ¸ì›Œí¬ ë ˆì´ì–´ì˜ ê°€ë…ì„± ë° ì¬ì‚¬ìš©ì„± í–¥ìƒì„ ê²½í—˜
- í”„ë¡œì íŠ¸ ê·œëª¨ê°€ ì»¤ì§ˆìˆ˜ë¡ viewModelë„ ë¹„ëŒ€í•´ì¡Œê³  viewModelì—ë„ ê°œì„ ì´ í•„ìš”í•˜ë‹¤ëŠ” ê±¸ ê²½í—˜
-->
